<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <title>TODO List</title>
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
</head>
<body class="bg-light">

<div class="container">
    <div class="py-5 text-center">
        <img class="d-block mx-auto mb-4" src="/todolist/img/logo.svg" alt="" width="72" height = "72">
        <h2>TODO List</h2>
    </div>
    <div class="row">
        <div class="col-md-4 order-md-1 mb-4">
            <h4 class="mb-3">New task:</h4>
            <form class="was-validated" id="form">
                <div class="mb-3">
                    <label for="description">Description</label>
                    <textarea class="form-control" rows=2 id="description" required></textarea>
                </div>
                <hr class="mb-4">
                <button type="button" class="btn btn-primary btn-block" onclick="return createItem();">Create</button>
            </form>
        </div>
        <div class="col-md-8 order-md-2 mb-4">
            <h4 class="mb-3">Tasks to do:</h4>
            <div class="custom-control custom-checkbox float-right">
                <input class="custom-control-input" type="checkbox" value="" id="showAll" onclick="fillInTable();">
                <!--form-check-input-->
                <label class="custom-control-label" for="showAll">Show all</label>
                <!--"form-check-label"-->
            </div>
            <table class="table table-sm top-buffer">
                <thead>
                <tr>
                    <th>Id</th>
                    <th>Description</th>
                    <th>Created</th>
                    <th>Done</th>
                </tr>
                </thead>
                <tbody id="tbody">
                </tbody>
            </table>
        </div>


    </div>
</div>
<script>
    $(document).ready(fillInTable());

    function sendItem(json) {
        let fullPath = window.location.href;
        let rootPath = fullPath.substring(0, fullPath.lastIndexOf('/')) + '/';
        $.ajax({
            type: 'POST',
            url: rootPath+'items',
            data: JSON.stringify(json),
            dataType: 'json'
        }).done(function(data) {
            fillInTable();
        });
    }
    function createItem() {
        if ($('#description').val() ==="") {
            return false;
        }
        let json ={};
        json.id = 0;
        json.description = $('#description').val();
        json.created = Date.now();
        json.done = false;
        sendItem(json);
        $('#description').val('');
        return true;
    }
    function changeItemStatus(checkbox) {
        let json = {};
        const $values = $(checkbox).parent().parent().find('td');
        json.id = $values.eq(0).text();
        json.description = $values.eq(1).text();
        json.created = Date.parse($values.eq(2).text());
        json.done = (checkbox.is(':checked'));
        sendItem(json);
    }
    function fillInTable() {
        let fullPath = window.location.href;
        let rootPath = fullPath.substring(0, fullPath.lastIndexOf('/')) + '/';
        $.ajax({
            type: 'GET',
            url: rootPath + 'items',
            dataType: 'json',
        }).done(function (data) {
            $("#tbody").empty();
            let items = data;
            items.sort(function(a, b) {
                return parseInt(a.id) - parseInt(b.id);
            });
            for (let j = 0; j <= items.length; j++) {
                if ($("#showAll").is(':checked') || !items[j].done) {
                    addItemToTable(items[j]);
                }
            }
        });
        return true;
    }
    function addItemToTable(data) {
        let checked = data.done ? ' checked="checked" ' : "";
        $('#tbody').append('<tr>\n'
            + '<td>' + data.id + '</td>\n'
            + '<td>' + data.description + '</td>\n'
            + '<td>' + data.created + '</td>\n'
            + '<td><input type="checkbox"' + checked + 'onclick="changeItemStatus($(this));">'
            + '</td>\n</tr>"')
    }
</script>
</body>
</html>